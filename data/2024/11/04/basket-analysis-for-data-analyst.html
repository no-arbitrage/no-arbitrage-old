<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-translate-customization" content="108d9124921d80c3-80e20d618ff053c8-g4f02ec6f3dba68b7-c">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Implementing Basket Analysis in Power BI and SQL - Association rule | No Arbitrage</title>
<meta name="generator" content="Jekyll v4.4.1">
<meta property="og:title" content="Implementing Basket Analysis in Power BI and SQL - Association rule">
<meta name="author" content="Joseph Cai">
<meta property="og:locale" content="en_US">
<meta name="description" content="No Arbitrate is a personal blog created to share practical data analytical and financial knowledge, ranging from basics theory to advanced concepts, from hands-on spreadsheet techniques to plug-and-play practical templates. A space for exchanging ideas, making connections, and inspiring each others. I also post my own or borrowed throughts on ESG sustainability subjects.">
<meta property="og:description" content="No Arbitrate is a personal blog created to share practical data analytical and financial knowledge, ranging from basics theory to advanced concepts, from hands-on spreadsheet techniques to plug-and-play practical templates. A space for exchanging ideas, making connections, and inspiring each others. I also post my own or borrowed throughts on ESG sustainability subjects.">
<link rel="canonical" href="https://no-arbitrage.github.io/no-arbitrage-old//data/2024/11/04/basket-analysis-for-data-analyst.html">
<meta property="og:url" content="https://no-arbitrage.github.io/no-arbitrage-old//data/2024/11/04/basket-analysis-for-data-analyst.html">
<meta property="og:site_name" content="No Arbitrage">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-11-04T00:00:00+00:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="Implementing Basket Analysis in Power BI and SQL - Association rule">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Joseph Cai"},"dateModified":"2024-11-04T00:00:00+00:00","datePublished":"2024-11-04T00:00:00+00:00","description":"No Arbitrate is a personal blog created to share practical data analytical and financial knowledge, ranging from basics theory to advanced concepts, from hands-on spreadsheet techniques to plug-and-play practical templates. A space for exchanging ideas, making connections, and inspiring each others. I also post my own or borrowed throughts on ESG sustainability subjects.","headline":"Implementing Basket Analysis in Power BI and SQL - Association rule","mainEntityOfPage":{"@type":"WebPage","@id":"https://no-arbitrage.github.io/no-arbitrage-old//data/2024/11/04/basket-analysis-for-data-analyst.html"},"url":"https://no-arbitrage.github.io/no-arbitrage-old//data/2024/11/04/basket-analysis-for-data-analyst.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="icon" href="/assets/images/brand/favicon.ico">
  <link rel="canonical" href="url(https://no-arbitrage.github.io/no-arbitrage-old/)">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-noto-sans@0.0.72/index.min.css">
  <link rel="stylesheet" href="/assets/css/main.css">
  <script src="/assets/js/main.js"></script>

<!--Roboto Font from Google-->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&amp;family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&amp;family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&amp;display=swap" rel="stylesheet">
<!--Roboto Font from Google-->

  <!-- <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script> -->

  <!--  -->

  <!--  --><link type="application/atom+xml" rel="alternate" href="https://no-arbitrage.github.io/no-arbitrage-old//feed.xml" title="No Arbitrage">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
<!-- and it's easy to individually load additional languages -->
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/go.min.js" async></script>



















<script>
// Init highlight js
document.addEventListener('DOMContentLoaded', function(event) {
  var els = document.querySelectorAll('pre code')

  function addLangData(block) {
    var outer = block.parentElement.parentElement.parentElement;
    var lang = block.getAttribute('data-lang');
    for (var i = 0; i < outer.classList.length; i++) {
      var cls = outer.classList[i];
      if (cls.startsWith('language-')) {
        lang = cls;
        break;
      }
    }
    if (!lang) {
      cls = block.getAttribute('class');
      lang = cls ? cls.replace('hljs ', '') : '';
    }
    if (lang.startsWith('language-')) {
      lang = lang.substr(9);
    }
    block.setAttribute('class', 'hljs ' + lang);
    block.parentNode.setAttribute('data-lang', lang);
  }

  function addBadge(block) {
    var enabled = ('true' || 'true').toLowerCase();
    if (enabled == 'true') {
      var pre = block.parentElement;
      pre.classList.add('badge');
    }
  }

  function handle(block) {
    addLangData(block);
    addBadge(block)
    hljs.highlightBlock(block);
  }

  for (var i = 0; i < els.length; i++) {
    var el = els[i];
    handle(el);
  }
});
</script>

<style>
  /* code language badge */
  pre.badge::before {
    content: attr(data-lang);
    color: #fff;
    background-color: #ff4e00;
    padding: 0 .5em;
    border-radius: 0 2px;
    text-transform: uppercase;
    text-align: center;
    min-width: 32px;
    display: inline-block;
    position: absolute;
    right: 0;
  }

  /* fix wrong badge display for firefox browser */
  code > table pre::before {
    display: none;
  }
</style>
<script src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/5.3.7/umd/photoswipe-lightbox.umd.min.js" async></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/photoswipe/5.3.7/umd/photoswipe.umd.min.js" async></script>
<link href="//cdnjs.cloudflare.com/ajax/libs/photoswipe/5.3.7/photoswipe.min.css" rel="stylesheet">
<style>
  .pswp .pswp__container .pswp__img {
    background-color: white;
  }
</style>

<script>
  function initPhotoSwipe() {
    let customOptions = {};

    try {
      const data = ``.replaceAll("=>", ":");
      customOptions = JSON.parse(data);
    } catch (e) {
      console.info("Invalid custom photo previewer options! " + e.message);
    }

    // Define object and gallery options
    const options = Object.assign(
      {
        gallery: "section.main",
        children: "a.photo-swipe",
        photo_scale: 2,
        // dynamic import is not supported in UMD version
        pswpModule: PhotoSwipe,
      },
      customOptions
    );

    const galleryEl = document.querySelector(options.gallery);
    if (!galleryEl) {
      return;
    }

    const imgEls = [];
    const els = galleryEl.querySelectorAll("img:not(.emoji)");
    els.forEach((el) => {
      if (el.src.trim() == "") {
        return;
      }
      if (!imgEls.includes(el)) {
        imgEls.push(el);
      }
    });

    if (imgEls.length === 0) {
      return;
    }

    imgEls.forEach((imgEl) => {
      imgEl.outerHTML = `
      <a class="photo-swipe"
        href="${imgEl.src}"
        data-pswp-width="${
          Math.max(imgEl.naturalWidth, imgEl.width) * options.photo_scale
        }"
        data-pswp-height="${
          Math.max(imgEl.naturalHeight, imgEl.height) * options.photo_scale
        }"
        data-pswp-caption="${imgEl.getAttribute("caption") || imgEl.alt}"
        target="_blank">
        ${imgEl.outerHTML}
      </a>`;
    });

    // Initialize PhotoSwipe 5
    var lightbox = new PhotoSwipeLightbox(options);

    lightbox.init();
  }

  window.addEventListener("load", initPhotoSwipe);
</script>



<link rel="icon" type="image/png" href="/assets/images/brand/favicon-48x48.png" sizes="48x48">
<link rel="icon" type="image/svg+xml" href="/assets/images/brand/favicon.svg">
<link rel="shortcut icon" href="/assets/images/brand/favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/brand/apple-touch-icon.png">
<meta name="apple-mobile-web-app-title" content="No Arbitrage (Blog)">
<link rel="manifest" href="/assets/images/brand/site.webmanifest">


<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous"> -->
<!--  -->
</head>
<body>


























































































































<header class="site-header " role="banner">

  <div class="wrapper">
    <div class="site-header-inner">
<span class="site-brand"><a class="site-brand-inner" rel="author" href="/">
  <img class="site-favicon" title="No Arbitrage" src="/assets/images/brand/favicon.ico" onerror="this.style.display='none'">
  No Arbitrage
</a>
</span><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger">
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewbox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
              </svg>
            </span>
          </label>

          <div class="trigger">
<a class="page-link" href="/about.html">ABOUT</a><a class="page-link" href="/categories.html">CATEGORIES</a><a class="page-link" href="/tags.html">TAGS</a><a class="page-link" href="/">HOME</a><a class="page-link" href="/archives.html">ARCHIVES</a><a class="page-link" href="/resource.html">RESOURCE</a>









<div class="page-link" style="display: inline;">



<div id="google_translate_element" style="display: none;">
</div>

<div class="ct-language">
  <ul class="list-unstyled ct-language-dropdown">
    
      <li>
        <a href="#" class="lang-select" data-lang="en">
          
          <img src="https://cdn.countryflags.com/thumbs/united-states-of-america/flag-400.png" title="English">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="fr">
          
          <img src="https://cdn.countryflags.com/thumbs/france/flag-400.png" title="French">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="zh-CN">
          
          <img src="https://cdn.countryflags.com/thumbs/china/flag-400.png" title="Chinese(Simple)">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="ja">
          
          <img src="https://cdn.countryflags.com/thumbs/japan/flag-400.png" title="Japanese">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="ko">
          
          <img src="https://cdn.countryflags.com/thumbs/south-korea/flag-400.png" title="Korean">
          
        </a>
      </li>
    
      <li>
        <a href="#" class="lang-select" data-lang="ru">
          
          <img src="https://cdn.countryflags.com/thumbs/russia/flag-400.png" title="Russian">
          
        </a>
      </li>
    
  </ul>
</div>

<script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({
    pageLanguage: 'en',
    autoDisplay: false,
    layout: google.translate.TranslateElement.InlineLayout.VERTICAL
  }, 'google_translate_element');

  // Links to cross-origin destinations are unsafe
  var gll = document.getElementsByClassName('goog-logo-link')[0];
  if (gll) {
    gll.setAttribute('rel', 'noopener');
  }

  function restoreLang() {
    var iframe = document.getElementsByClassName('goog-te-banner-frame')[0];
    if (!iframe) return;

    var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
    var restore_el = innerDoc.getElementsByTagName("button");

    for (var i = 0; i < restore_el.length; i++) {
      if (restore_el[i].id.indexOf("restore") >= 0) {
        restore_el[i].click();
        var close_el = innerDoc.getElementsByClassName("goog-close-link");
        close_el[0].click();
        return;
      }
    }
  }

  function triggerHtmlEvent(element, eventName) {
    var event;
    if (document.createEvent) {
      event = document.createEvent('HTMLEvents');
      event.initEvent(eventName, true, true);
      element.dispatchEvent(event);
    } else {
      event = document.createEventObject();
      event.eventType = eventName;
      element.fireEvent('on' + event.eventType, event);
    }
  }

  var googleCombo = document.querySelector("select.goog-te-combo");
  var langSelect = document.querySelector('.ct-language');
  langSelect.addEventListener('click', function(event) {
    if (!event.target) {
      return;
    }

    var selected = document.querySelector('.ct-language .ct-language-selected');
    if (selected) {
      selected.classList.remove('ct-language-selected');
    }

    var target = event.target;
    while (target && target !== langSelect ) {
      if (target.matches('.lang-select')) {
        break;
      }
      target = target.parentElement;
    }

    if (target && target.matches('.lang-select')) {
      var lang = target.getAttribute('data-lang');
      if (googleCombo.value == lang) {
        restoreLang();
      } else {
        target.parentElement.classList.add('ct-language-selected');
        googleCombo.value = lang;
        triggerHtmlEvent(googleCombo, 'change');
      }
    }

    event.preventDefault();
  });
}
</script>

<script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" async></script>
</div>
</div>
        </nav>
</div>
  </div>
</header>

<script>
  function initHeader() {
    var lastScrollY = getScrollPos().y;
    var documentElement = document.documentElement;

    function storeScrollData() {
      var y = getScrollPos().y;var scrollStatus = "";

      if (y <= 0) {
        scrollStatus = "top";
      } else if ((window.innerHeight + y) >= document.body.offsetHeight) {
        scrollStatus = "bottom";
      } else {
        var isScrollDown = (y - lastScrollY > 0) ? true : false;
        scrollStatus = isScrollDown ? "down" : "up";
      }

      lastScrollY = y;
      documentElement.setAttribute("data-scroll-status", scrollStatus);
    }

    window.addEventListener('scroll', function(e) {
      storeScrollData();
    });

    storeScrollData();
  }
  document.addEventListener('DOMContentLoaded', initHeader);
</script>















































































































































<script>
  function hashLocate(hashValue) {
    hashValue = hashValue.replace(/^.*#h-/, '');
    hashValue = decodeURIComponent(hashValue);
    var element = document.getElementById(hashValue);

    if (!element) {
      return;
    }

    var header = document.querySelector('header.site-header');
    var headerRect = header.getBoundingClientRect();
    var headerTop = Math.floor(headerRect.top);
    var headerHeight = Math.floor(headerRect.height);
    var scrollPos = getScrollPos();
    var offsetY = element.offsetTop - (headerTop + headerHeight + 20);

    if (offsetY == scrollPos.y) {
      return;
    }

    if (headerTop == 0  && offsetY > scrollPos.y) {
      offsetY += headerHeight + 2;
    } else if (headerTop < 0  && offsetY < scrollPos.y) {
      offsetY -= headerHeight - 2;
    }

    smoothScrollTo(offsetY);
  }

  // The first event occurred
  window.addEventListener('load', function(event) {
    if (window.location.hash) {
      hashLocate(window.location.hash);
    }
  });

  // The first event occurred
  window.addEventListener('click', function(event) {
    if (event.target.tagName.toLowerCase() == 'a') {
      hashLocate(event.target.getAttribute('href'));
    }
  });
</script>
<div class="theme-toggle">
  <input type="checkbox" id="theme-switch">
  <label for="theme-switch">
    <div class="toggle"></div>
    <div class="names">
      <p class="light">Light</p>
      <p class="dark">Dark</p>
    </div>
  </label>
</div>




<script>
  (function() {
    var sw = document.getElementById('theme-switch');
    var html = document.getElementsByTagName('html')[0];
    var nightModeOption = ('auto' || 'auto').toLowerCase();
    var storage = nightModeOption === 'manual'
        ? localStorage
        : sessionStorage;
    var themeData = loadThemeData();

    function saveThemeData(data) {
      storage.setItem('theme', JSON.stringify(data));
    }

    function loadThemeData() {
      var data = storage.getItem('theme');
      try {
        data = JSON.parse(data ? data : '');
      } catch(e) {
        data = { nightShift: undefined, autoToggleAt: 0 };
        saveThemeData(data);
      }
      return data;
    }

    function handleThemeToggle(nightShift) {
      themeData.nightShift = nightShift;
      saveThemeData(themeData);
      html.dataset.theme = nightShift ? 'dark' : 'light';
      setTimeout(function() {
        sw.checked = nightShift ? true : false;
      }, 50);
    }

    function autoThemeToggle() {
      // Next time point of theme toggle
      var now = new Date();
      var toggleAt = new Date();
      var hours = now.getHours();
      var nightShift = hours >= 19 || hours <=7;

      if (nightShift) {
        if (hours > 7) {
          toggleAt.setDate(toggleAt.getDate() + 1);
        }
        toggleAt.setHours(7);
      } else {
        toggleAt.setHours(19);
      }

      toggleAt.setMinutes(0);
      toggleAt.setSeconds(0);
      toggleAt.setMilliseconds(0)

      var delay = toggleAt.getTime() - now.getTime();

      // auto toggle theme mode
      setTimeout(function() {
        handleThemeToggle(!nightShift);
      }, delay);

      return {
        nightShift: nightShift,
        toggleAt: toggleAt.getTime()
      };
    }

    // Listen the theme toggle event
    sw.addEventListener('change', function(event) {
      handleThemeToggle(event.target.checked);
    });

    if (nightModeOption == 'auto') {
      var data = autoThemeToggle();

      // Toggle theme by local setting
      if (data.toggleAt > themeData.autoToggleAt) {
        themeData.autoToggleAt = data.toggleAt;
        handleThemeToggle(data.nightShift);
      } else {
        handleThemeToggle(themeData.nightShift);
      }
    } else if (nightModeOption == 'manual') {
      handleThemeToggle(themeData.nightShift);
    } else {
      var nightShift = themeData.nightShift;
      if (nightShift === undefined) {
        nightShift = nightModeOption === 'on';
      }
      handleThemeToggle(nightShift);
    }
  })();
</script>
<div id="click-to-top" class="click-to-top">
  <i class="fa fa-arrow-up"></i>
</div>
<script>
  (function () {
    const clickToTop = document.getElementById('click-to-top');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 100) {
        clickToTop.classList.add('show')
      }else {
        clickToTop.classList.remove('show')
      }
    });
    clickToTop.addEventListener('click', () => {
      window.smoothScrollTo(0);
    });
  })();
</script>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="framework">
  <section class="main">

     <div class="post">
  <section>









<header class="post-header">
  <h1 class="post-title p-name" itemprop="name headline">Implementing Basket Analysis in Power BI and SQL - Association rule</h1>
  <h2 class="post-subtitle">Basket Analysis for Data analyst</h2>

  <div class="post-meta">
    <time class="dt-published" datetime="2024-11-04T00:00:00+00:00" itemprop="datePublished"><i class="fa fa-calendar"></i> 04 Nov 2024
    </time>
    
































    <span class="post-reading-time left-vsplit"><i class="fa fa-clock-o"></i> About 9 mins</span>
  </div>
<div class="post-tags">
<a class="post-tag" href="/tags.html#basket-analysis">#basket-analysis</a><a class="post-tag" href="/tags.html#excel">#excel</a><a class="post-tag" href="/tags.html#templates">#templates</a>
</div></header>


<style>
#share-buttons {display: inline-block; vertical-align: middle; }
#share-buttons:after {content: ""; display: block; clear: both;}
#share-buttons > div {
    position: relative;
    text-align: left; 
    height: 36px; 
    width: 32px; 
    float: left; 
    text-align: center;
}
#share-buttons > div > svg {height: 16px; fill: #d5d5d5; margin-top: 10px;}
#share-buttons > div:hover {cursor: pointer;}
#share-buttons > div.facebook:hover > svg {fill: #3B5998;}
#share-buttons > div.twitter:hover > svg {fill: #55ACEE;}
#share-buttons > div.linkedin:hover > svg {fill: #0077b5;}
#share-buttons > div.pinterest:hover > svg {fill: #CB2027;}
#share-buttons > div.mail:hover > svg {fill: #7D7D7D;}
#share-buttons > div.instagram:hover > svg {fill: #C73B92;}
#share-buttons > div.facebook > svg {height: 18px; margin-top: 9px;}
#share-buttons > div.twitter > svg {height: 20px; margin-top: 8px;}
#share-buttons > div.linkedin > svg {height: 19px; margin-top: 7px;}
#share-buttons > div.pinterest > svg {height: 20px; margin-top: 9px;}
#share-buttons > div.mail > svg {height: 14px; margin-top: 11px;}
</style>

<span style="color: silver;">Share on: </span><div id="share-buttons">
    <div class="facebook" title="Share this on Facebook" onclick="window.open('http://www.facebook.com/share.php?u=https://no-arbitrage.github.io/no-arbitrage-old//data/2024/11/04/basket-analysis-for-data-analyst.html');"><svg viewbox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"></path></svg></div>
    <div class="twitter" title="Share this on Twitter" onclick="window.open('ttps://twitter.com/intent/tweet?text=https://no-arbitrage.github.io/no-arbitrage-old//data/2024/11/04/basket-analysis-for-data-analyst.html');"><svg viewbox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"></path></svg></div>
    <div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=https://no-arbitrage.github.io/no-arbitrage-old//data/2024/11/04/basket-analysis-for-data-analyst.html&amp;title=&amp;summary=&amp;source=');"><svg viewbox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"></path></svg></div>
    
    <div class="mail" title="Share this through Email" onclick="window.open('mailto:?&amp;body=https://no-arbitrage.github.io/no-arbitrage-old//data/2024/11/04/basket-analysis-for-data-analyst.html');"><svg viewbox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 710v794q0 66-47 113t-113 47h-1472q-66 0-113-47t-47-113v-794q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 100-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38-42.5-30.5q-91-64-262-182.5t-205-142.5q-62-42-117-115.5t-55-136.5q0-78 41.5-130t118.5-52h1472q65 0 112.5 47t47.5 113z"></path></svg></div>
</div>
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="post-content e-content" itemprop="articleBody">

      <p><img src="/assets/images/posts/heidi-fin-2TLREZi7BUg-unsplash.jpg" alt="banner"></p>

<p>Images: Heidi Fin (unsplash.com)</p>

<h1 id="power-bi-dax-implementation">Power BI (DAX) Implementation</h1>

<h2 id="goal">Goal</h2>

<p>This post is share my experience of implementing basket analysis in Power BI and sql. At the end of this post, I will attach links for my Power BI file. Please note this power BI is receiving updates as I write new posts.</p>

<p>You can find the Power BI file here, some screeshots are provided in this post</p>

<p>Attachment: <a href="https://no-arbitrage.github.io/no-arbitrage-old//assets/pbix/241103_AdventureWorks_na.pbix">241103_AdventureWorks_na.pbix</a></p>

<h2 id="key-idea">Key Idea</h2>

<p>Basket analysis using Association Rule, involves understanding purchase patterns over time to see how products relate to each other within a customer’s buying journey. In this approach, each customer is viewed as a “basket,” meaning we analyze product relationships based on all items they’ve bought, across different orders. The purpose is to find patterns in what customers purchase together, over time, rather than in a single transaction.</p>

<p>Key metrics, like <em>support</em>, <em>confidence</em>, and <em>lift</em>, are used to understand these product relationships:</p>

<ul>
  <li>
<strong>Support</strong>: The percentage of total customers who bought both items. It gives a sense of the prevalence of a combination in the overall population.</li>
  <li>
<strong>Confidence</strong>: The likelihood that a customer who bought one product also bought another.</li>
  <li>
<strong>Lift</strong>: The strength of the association between two products. A lift greater than 1 implies a meaningful association that could predict future purchases.</li>
</ul>

<p>For example, if “Computers” and “Cell phones” frequently appear in a customer’s purchase history, the analysis could reveal that customers who buy “Cell phones” have a high likelihood of also purchasing “Computers,” helping companies understand customer preferences and potentially guiding personalized marketing strategies.</p>

<h3 id="step-1-cartesian--product-of-product-with-itself">Step 1: Cartesian  product of Product with itself</h3>

<p>Create a Cartesian  product of Product with itself(And Product) on a calculated table and calculate the common customers of each combination</p>

<pre><code class="language-jsx">DEFINE MEASURE [# Customers Both (Internal)] = 

 VAR CustomersWithAndProducts =
    CALCULATETABLE (
        DISTINCT ( Sales[CustomerKey] ),
        REMOVEFILTERS ( 'Product' ),
        REMOVEFILTERS ( Sales[ProductKey] ),
        USERELATIONSHIP ( Sales[ProductKey], 'And Product'[And ProductKey] )
    )
VAR Result =
    CALCULATE ( [# Customers], KEEPFILTERS ( CustomersWithAndProducts ) )
RETURN
    Result
------------------------------------------
EVALUATE
RawProductsCustomers = 
FILTER (
    SUMMARIZECOLUMNS (
        'Sales'[ProductKey],
        'And Product'[And ProductKey],
        "Customers", [# Customers Both (Internal)]
    ),
    NOT ISBLANK ( [Customers] ) &amp;&amp; 'And Product'[And ProductKey] &lt;&gt; 'Sales'[ProductKey]
)
</code></pre>

<h3 id="step-2-customer-support">Step 2: Customer Support.</h3>

<p>Customer Support has a difficult name, but the idea is “what’s ratio of number of common customers of each combination and total number of customers.”</p>

<pre><code class="language-jsx">DEFINE MEASURE [# Customers Both] = 
VAR ExistingAndProductKey =
    CALCULATETABLE (
        DISTINCT ( RawProductsCustomers[And ProductKey] ),
        TREATAS (
            DISTINCT ( 'And Product'[And ProductKey] ),
            RawProductsCustomers[And ProductKey]
        )
    )
VAR FilterAndProducts =
    TREATAS (
        EXCEPT (
            ExistingAndProductKey,
            DISTINCT ( 'Product'[ProductKey] )
        ),
        Sales[ProductKey]
    )
VAR CustomersWithAndProducts =
    CALCULATETABLE (
        SUMMARIZE ( Sales, Sales[CustomerKey] ),
        REMOVEFILTERS ( 'Product' ),
        FilterAndProducts
    )
VAR Result =
    CALCULATE (
        [# Customers],
        KEEPFILTERS ( CustomersWithAndProducts )
    )
RETURN
    Result
----------------------------------------------------
DEFINE MEASURE [# Customers Total] **=** 
CALCULATE ( 
    ****[# Customers], 
    ****REMOVEFILTERS ( 'Product' ) 
**)**
    
----------------------------------------------------    
DEFINE MEASURE [% Customers Support] = 
DIVIDE ( [# Customers Both], [# Customers Total] )
    

</code></pre>

<p>Wait, why this common customer is so mess here. Let’s dive into the measure. The core logic here is to first, get the number of customers in the first list of Products, which is a standard measure [# Basket]. Then, you want to use a list of customers for And Product  as a filter to filter this measure. This is called Table Filter technique in DAX, relatively advanced concept in DAX.</p>

<p>Then the question becomes How to do you get this list of customers for And Product? You first use TREATAS to connect the sales table and And Product table,, once they are connected, you can summarize this sales table (with data lineage) by customers. This technique is called Data Lineage. is a basic concept, however easy to trip over even for advanced DAX users.</p>

<h3 id="step-3-customer-lift">Step 3: Customer Lift.</h3>

<p>Customer Lift is nothing complex but a comparison of two ratios. Don’t get fooled by its sophisticated name. This measure is comparing the first ratio we calculated above to a second ratio, “What is the ratio of customers for <strong>And Product</strong> to total number of customers.</p>

<pre><code>$
$\frac{Common customers /total customers}{Product B customers / total customers}$
$
</code></pre>

<p><strong>This is saying how much more likely customers are to purchase a product (Product) when they have already bought another related product (And Product)</strong></p>

<pre><code class="language-jsx">Customers Lift = 
DIVIDE (
    [% Customers Confidence],
    DIVIDE (
        [# Customers And],
        [# Customers Total]
    )
)
</code></pre>

<h3 id="attribution"><strong>Attribution</strong></h3>

<p>This pattern is included in the book <a href="https://www.daxpatterns.com/books/dax-patterns-second-edition/"><strong>DAX Patterns, Second Edition</strong></a>. by [<strong>Alberto Ferrari](http://www.sqlbi.com/articles/author/alberto-ferrari/) and <a href="http://www.sqlbi.com/articles/author/marco-russo/">Marco Russo</a>.  I highly recommend their content. It’s excellent work. They are dedicated DAX teachers with comprehensive DAX knowledge. Their work is systematic and excellent.</strong></p>

<h1 id="comment-on-the-power-bi-implementation">Comment on the Power BI Implementation</h1>

<p>To be fully honest, DAX is not the best language to implement this analysis. First reason is that DAX’s advantage in Context Transitions complicated the code from both writer and report readers’ point of view.  Secondly, it is highly likely the data becomes so large that the report runs slow. The Power BI advantages in producing dynamic computation as user consumes the report doesn’t really shine in this situation.</p>

<p>Instead, I find SQL implemtation is really easy to understand.</p>

<h1 id="sql-implementation">SQL Implementation</h1>

<p>This is based on schema of SAP Business One with SQL version v10.0
The SalesAnalysis is a replicated view of the SAP stock sales anaysis report.</p>

<pre><code class="language-sql">
CREATE PROCEDURE [dbo].[BasketAnalysis]

@CardCode NVARCHAR(50) = NULL,
@LastNMonth INT = 12
	 
AS
BEGIN

DECLARE @AssoStartDate DATE = DATEFROMPARTS ( YEAR ( GETDATE()) -2, 1,1) 
DECLARE @MinRepeatOrd INT = 2 -- Minimal repeated orders that a customer has to place for this item to be considered a regular item of a customer



; WITH AssoCardCat AS (
    SELECT 
    T80.ItmsGrpNam, 
    T80.CardCode, 
    CAST ( COUNT(T80.CardCode) OVER (PARTITION BY T80.ItmsGrpNam ) AS DECIMAL(10,5) )[CatCustomers]
    FROM 
    (
        SELECT 
        T99.CardCode, 
        T99.ItmsGrpNam,
        COUNT ( DISTINCT T99.DocNum ) [OrdCount],
        COUNT ( DISTINCT T99.itemCode) [ActiveLines]
        FROM SalesAnalysis T99

        WHERE
        T99.DocDate &gt;= @AssoStartDate AND
        T99.Sales &gt; 0 AND
        T99.ItmsGrpCod NOT IN (158, 163, 229) AND
        T99.ProjectCod IN ('WCT', 'CRE', 'EXP')

        GROUP BY 
        T99.CardCode, 
        T99.ItmsGrpNam
    ) T80 
    WHERE T80.OrdCount &gt; @MinRepeatOrd
) 
, AssoCustomerCat AS 
(
	SELECT *
	FROM 
	(
		SELECT
		T99.*,
		Prob_A		=  T99.CustomersforCatA/ T99.TotalCustomers , 
		Prob_B		= T99.CustomersforCatB / T99.TotalCustomers,
		Support		=	T99.CommonCustomers / T99.TotalCustomers,

		Confidence	=	T99.CommonCustomers / T99.CustomersforCatA , -- Out of total A customers, how many are into B

		Lift		=  (T99.CommonCustomers / T99.TotalCustomers )  / 
					(( T99.CustomersforCatA/ T99.TotalCustomers)  * (  T99.CustomersforCatB / T99.TotalCustomers ) ), 
		LiftRankInCat   = ROW_NUMBER() OVER 
		(
		  PARTITION BY T99.CategoryA
		  ORDER BY (T99.CommonCustomers / T99.TotalCustomers )  / 
					(( T99.CustomersforCatA/ T99.TotalCustomers)  * (  T99.CustomersforCatB / T99.TotalCustomers ) ) DESC  
		)
	
		FROM 
		(
			SELECT 
			T0.ItmsGrpNam [CategoryA], 
			T0.CatCustomers [CustomersforCatA], 
			T1.ItmsGrpNam [CategoryB], 
			T1.CatCustomers [CustomersforCatB],
			CAST ( COUNT ( T0.CardCode ) AS DECIMAL (10,5)) [CommonCustomers], 
			TotalCustomers = 
			(
					SELECT COUNT( DISTINCT T0.CardCode) 
					FROM SalesAnalysis T0 
					WHERE
					T0.DocDate &gt;= @AssoStartDate AND
					T0.Sales &gt; 0 AND
					T0.ItmsGrpCod NOT IN (158, 163, 229) AND
					T0.ProjectCod IN ('WCT', 'CRE', 'EXP')
			)

			FROM AssoCardCat T0 
			JOIN AssoCardCat T1 ON T1.CardCode = T0.CardCode AND T1.ItmsGrpNam &lt; T0.ItmsGrpNam
			GROUP BY 
			T0.ItmsGrpNam, T1.ItmsGrpNam, 
			T0.CatCustomers, T1.CatCustomers
		) T99 WHERE T99.CustomersforCatA != 0 AND T99.CustomersforCatB != 0
	) T100 WHERE T100.Lift &gt; 1 
), 
CustomerSpecific AS 
(
	SELECT 
	T100.* , 
	SUM(T100.[CategorySpend]) OVER ()[TotalSpend], 
	T100.[CategorySpend]  / SUM(T100.[CategorySpend]) OVER () [SpendPct], 
	SpendRank = 
	ROW_NUMBER () OVER (ORDER BY T100.[CategorySpend] DESC ) 
	FROM 
	(
		SELECT 
		SA.CardCode, 
		SA.CardName, 
		SA.ItmsGrpCod, 
		SA.ItmsGrpNam, 
		SUM(SA.Sales) [CategorySpend] 

		FROM SalesAnalysis SA 
		WHERE SA.CardCode = @CardCode
		AND  
		( 
			SA.DocDate BETWEEN EOMONTH ( GETDATE(), -1 * @LastNMonth -1 ) AND GETDATE()
		) 
		AND SA.ItmsGrpCod NOT IN ( 229, 158, 163 ) 
		GROUP BY SA.CardCode, 
		SA.CardName, 
		SA.ItmsGrpCod, 
		SA.ItmsGrpNam
	) T100 
) 
, FullReport AS 
(
	SELECT 
	T0.*,
	T1.CustomersforCatA [CustomersforCat], 
	T1.CategoryB [RecommendCat], 
	T1.CustomersforCatB [CustommersInRecommCat], 
	T1.TotalCustomers, 
	T1.Prob_A, 
	T1.Prob_B, 
	T1.Support,
	T1.Confidence, 
	T1.Lift 
	--RecommLine = 
	--T1.CategoryB + '(Confi: ' + CONVERT (NVARCHAR(10),  ROUND ( T1.Confidence * 100  ,0 )  ) 
	--+  ' - Lift: ' + CONVERT (NVARCHAR(10),  ROUND ( T1.Lift * 100  ,0 )  ) + ')'
	FROM CustomerSpecific T0 
	LEFT JOIN AssoCustomerCat T1 ON T1.CategoryA = T0.ItmsGrpNam 
	AND T1.CategoryB NOT IN 
	(
		SELECT 
		T99.ItmsGrpNam
		FROM CustomerSpecific T99
	) 
), 
Overview AS 
(
	SELECT 
	T0.CardCode, 
	T0.CardName,
	ROW_NUMBER() OVER (ORDER BY MAX( T0.Lift) DESC) [LiftRank],
	ROW_NUMBER() OVER (ORDER BY MAX ( T0.Confidence) DESC ) [ConfiRank], 
	T0.RecommendCat, 
	T0.CustommersInRecommCat,
	COUNT( T0.ItmsGrpNam ) BaseCount, 
	-- STRING_AGG ( RecommLine, ',' ) BaseReason, 
	MAX( T0.Lift) [MaxLift],
	MAX(T0.Confidence) [MaxConfi]
	FROM FullReport T0
	WHERE T0.RecommendCat IS NOT NULL
	GROUP BY T0.RecommendCat,
	T0.CardCode, 
	T0.CardName,
	T0.CustommersInRecommCat
)
SELECT * FROM Overview
END
</code></pre>

<h2 id="vesion-for-sales-mangers">Vesion for Sales Mangers</h2>

<p>If all this is too complex for you and you are only interested in using this technique to analyst your own data and get insights from that. you can follow another post of mine.</p>

<p><a href="/data/2024/11/04/basket-analysis-for-sales-managers.html">Basket Analysis for Sales Managers</a></p>



    </div>

</article>
<div class="post-nav">
<a class="previous" href="/finance/2024/11/04/about-return-concept.html" title="Calculating Returns">Calculating Returns</a><a class="next" href="/data/2024/11/04/basket-analysis-for-sales-managers.html" title="Unlocking cross sales opportunities with pre-made Basket Analysis template">Unlocking cross sales opportunities with pre-made...</a>
</div>

<style>
#share-buttons {display: inline-block; vertical-align: middle; }
#share-buttons:after {content: ""; display: block; clear: both;}
#share-buttons > div {
    position: relative;
    text-align: left; 
    height: 36px; 
    width: 32px; 
    float: left; 
    text-align: center;
}
#share-buttons > div > svg {height: 16px; fill: #d5d5d5; margin-top: 10px;}
#share-buttons > div:hover {cursor: pointer;}
#share-buttons > div.facebook:hover > svg {fill: #3B5998;}
#share-buttons > div.twitter:hover > svg {fill: #55ACEE;}
#share-buttons > div.linkedin:hover > svg {fill: #0077b5;}
#share-buttons > div.pinterest:hover > svg {fill: #CB2027;}
#share-buttons > div.mail:hover > svg {fill: #7D7D7D;}
#share-buttons > div.instagram:hover > svg {fill: #C73B92;}
#share-buttons > div.facebook > svg {height: 18px; margin-top: 9px;}
#share-buttons > div.twitter > svg {height: 20px; margin-top: 8px;}
#share-buttons > div.linkedin > svg {height: 19px; margin-top: 7px;}
#share-buttons > div.pinterest > svg {height: 20px; margin-top: 9px;}
#share-buttons > div.mail > svg {height: 14px; margin-top: 11px;}
</style>

<span style="color: silver;">Share on: </span><div id="share-buttons">
    <div class="facebook" title="Share this on Facebook" onclick="window.open('http://www.facebook.com/share.php?u=https://no-arbitrage.github.io/no-arbitrage-old//data/2024/11/04/basket-analysis-for-data-analyst.html');"><svg viewbox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"></path></svg></div>
    <div class="twitter" title="Share this on Twitter" onclick="window.open('ttps://twitter.com/intent/tweet?text=https://no-arbitrage.github.io/no-arbitrage-old//data/2024/11/04/basket-analysis-for-data-analyst.html');"><svg viewbox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"></path></svg></div>
    <div class="linkedin" title="Share this on Linkedin" onclick="window.open('https://www.linkedin.com/shareArticle?mini=true&url=https://no-arbitrage.github.io/no-arbitrage-old//data/2024/11/04/basket-analysis-for-data-analyst.html&amp;title=&amp;summary=&amp;source=');"><svg viewbox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"></path></svg></div>
    
    <div class="mail" title="Share this through Email" onclick="window.open('mailto:?&amp;body=https://no-arbitrage.github.io/no-arbitrage-old//data/2024/11/04/basket-analysis-for-data-analyst.html');"><svg viewbox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1792 710v794q0 66-47 113t-113 47h-1472q-66 0-113-47t-47-113v-794q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 100-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38-42.5-30.5q-91-64-262-182.5t-205-142.5q-62-42-117-115.5t-55-136.5q0-78 41.5-130t118.5-52h1472q65 0 112.5 47t47.5 113z"></path></svg></div>
</div>

    
    <div class="post-related">
      <div>Related Articles</div>
      <ul>
        <li class="top-post">
          <a class="post-link" href="/data/2024/11/04/basket-free-power-bi-template-showcase.html" title="Free Power Bi template - a showcase of dashboard development">
            Free Power Bi template - a showcase of dashboard development<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li>
<li class="top-post">
          <a class="post-link" href="/planning/2024/10/14/welcome-to-my-first-blog.html" title="Welcome to No Arbitrage!">
            Welcome to No Arbitrage!<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li>
<li class="top-post">
          <a class="post-link" href="/finance/2024/11/29/Hacking-Debt-schedule-with-Lambda-in-Excel.html" title="Hacking Debt schedule with Lambda in Excel">
            Hacking Debt schedule with Lambda in Excel<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li>
<li class="">
          <a class="post-link" href="/operational-reasearch/2024/11/17/Comparing-solvers-in-excel.html" title="Comparing Default Solvers in Excel">
            Comparing Default Solvers in Excel<span class="post-badges">
  <span class="post-badge badge-top">TOP</span>
  <span class="post-badge badge-new">NEW</span>
</span>
</a>
        </li>
</ul>
    </div>
<div class="post-comments">
<div id="utterances-placeholder"></div>
<script>
  const utterancesThemeFromDataTheme = () => {
    const dataTheme = document.documentElement.getAttribute('data-theme');
    return `github-${dataTheme}`;
  };

  const setUtterancesTheme = () => {
    const iframe = document.querySelector('.utterances-frame');
    if (iframe) {
      const message = {
        type: 'set-theme',
        theme: utterancesThemeFromDataTheme()
      };
      iframe.contentWindow.postMessage(message, 'https://utteranc.es');
    }
  }

  // dynamic change
  const observer = new MutationObserver((mutationsList, observer) => {
    for (let mutation of mutationsList) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
        setUtterancesTheme();
      }
    }
  });
  observer.observe(document.documentElement, { attributes: true, childList: false, subtree: false });

  let utterancesScript = document.createElement('script');
  utterancesScript.async = true;
  utterancesScript.src = 'https://utteranc.es/client.js';
  utterancesScript.crossOrigin = 'anonymous';
  utterancesScript.setAttribute('issue-term', 'title');
  utterancesScript.setAttribute('label', '📢admin');
  utterancesScript.setAttribute('repo', 'no-arbitrage/no-arbitrage.github.io');
  utterancesScript.setAttribute('theme', utterancesThemeFromDataTheme());

  const placeholder = document.getElementById('utterances-placeholder');
  placeholder.parentNode.replaceChild(utterancesScript, placeholder);
</script>
</div></section>
</div>


  </section>
  <section class="sidebar" style="margin-left: 15px;">
    <!-- Get sidebar items --><style type="text/css" media="screen">
.post-menu ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
</style>

<div class="post-menu">
  <div class="post-menu-title">TOC</div>
  <div class="post-menu-content"></div>
</div>

<script>
  function generateContent() {
    var menu = document.querySelector(".post-menu");
    var menuContent =  menu.querySelector(".post-menu-content");
    var headings = document.querySelector(".post-content").querySelectorAll("h2, h3, h4, h5, h6");

    // Hide menu when no headings
    if (headings.length === 0) {
      return menu.style.display = "none";
    }

    // Generate post menu
    var menuHTML = '';
    for (var i = 0; i < headings.length; i++) {
      var h = headings[i];
      menuHTML += (
        '<li class="h-' + h.tagName.toLowerCase() + '">'
        + '<a href="#h-' + h.getAttribute('id') + '">' + h.textContent + '</a></li>');
    }

    menuContent.innerHTML = '<ul>' + menuHTML + '</ul>';

    // The header element
    var header = document.querySelector('header.site-header');

    function doMenuCollapse(index, over_items) {
      var items = menuContent.firstChild.children;

      if (over_items == undefined) {
        over_items = 20;
      }

      if (items.length < over_items) {
        return;
      }

      var activeItem = items[index];
      var beginItem = activeItem
      var endItem = activeItem
      var beginIndex = index;
      var endIndex = index + 1;
      while (beginIndex >= 0
        && !items[beginIndex].classList.contains('h-h2')) {
        beginIndex -= 1;
      }
      while (endIndex < items.length
        && !items[endIndex].classList.contains('h-h2')) {
        endIndex += 1;
      }
      for (var i = 0; i < beginIndex; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
      for (var i = beginIndex + 1; i < endIndex; i++) {
        item = items[i]
        // if (!item.classList.contains('h-h2')) {
          item.style.display = '';
        // }
      }
      for (var i = endIndex; i < items.length; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
    }

    // Init menu collapsed
    doMenuCollapse(-1);

    // Active the menu item
    window.addEventListener('scroll', function (event) {
      var lastActive = menuContent.querySelector('.active');
      var changed = true;
      var activeIndex = -1;
      for (var i = headings.length - 1; i >= 0; i--) {
        var h = headings[i];
        var headingRect = h.getBoundingClientRect();
        var headerRect = header.getBoundingClientRect();
        var headerTop = Math.floor(headerRect.top);
        var headerHeight = Math.floor(headerRect.height);
        var headerHeight = headerTop + headerHeight + 20;
        if (headingRect.top <= headerHeight) {
          var id = 'h-' + h.getAttribute('id');
          var a = menuContent.querySelector('a[href="#' + id  + '"]');
          var curActive = a.parentNode;
          if (curActive) {
            curActive.classList.add('active');
            activeIndex = i;
          }
          if (lastActive == curActive) {
            changed = false;
          }
          break;
        }
      }
      if (changed) {
        if (lastActive) {
          lastActive.classList.remove('active');
        }
        doMenuCollapse(activeIndex);
      }
      event.preventDefault();
    });
  }
  generateContent();
</script>
</section>
</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">
    <div class="site-footer-inner">
<div>Copyright © No Arbitrage (2023-2025) by Joseph Cai.</div>
      <div>Powered by
        <a title="GitHub" href="https://github.com/no-arbitrage/no-arbitrage.github.io">GitHub</a>,
        <a title="Jekyll is a simple, blog-aware, static site generator." href="https://jekyllrb.com/">Jekyll</a> &amp;
        <a title="Yat, yet another theme." href="https://github.com/jeffreytse/jekyll-theme-yat">Yat-Theme</a>.
      </div>
      <div class="footer-col rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a>
</div>
    </div>
  </div>
</footer>
</body>
</html><html>
<script src='%E2%80%9Dhttps://polyfill.io/v3/polyfill.min.js?features=es6"'></script>
<script id="”MathJax-script”" async src='%E2%80%9Dhttps://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"'></script>
</html>
